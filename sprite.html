<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sprite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    /* 悬浮球容器 */
    .sprite-container {
      position: relative;
      width: 64px;
      height: 64px;
    }
    .sprite-ball {
      width: 56px;
      height: 56px;
      position: absolute;
      top: 4px;
      left: 4px;
      border-radius: 50%;
      background: linear-gradient(
        135deg,
        #667eea 0%,
        #764ba2 25%,
        #f093fb 50%,
        #f5576c 75%,
        #667eea 100%
      );
      background-size: 400% 400%;
      animation: flow 8s ease infinite;
      border: 2px solid rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      transition: transform 0.15s, border-color 0.15s;
      z-index: 2;
    }
    .sprite-ball:hover {
      transform: scale(1.08);
      border-color: rgba(255,255,255,0.6);
    }
    .sprite-ball.dragging {
      cursor: grabbing;
      transform: scale(1.0);
    }
    /* 录音中状态 */
    .sprite-ball.recording {
      background: linear-gradient(
        135deg,
        #e53935 0%,
        #d32f2f 25%,
        #ff5252 50%,
        #ff1744 75%,
        #e53935 100%
      );
      animation: flow 2s ease infinite, pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.6); }
      50% { box-shadow: 0 0 0 8px rgba(229, 57, 53, 0); }
    }
    .sprite-icon {
      width: 32px;
      height: 32px;
      pointer-events: none;
    }
    /* 录音图标 */
    .recording-icon {
      display: none;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 4px;
    }
    .sprite-ball.recording .sprite-icon {
      display: none;
    }
    .sprite-ball.recording .recording-icon {
      display: block;
    }
    @keyframes flow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* 旋转光环 */
    .orbit-ring {
      position: absolute;
      top: 0;
      left: 0;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: rgba(102, 126, 234, 0.8);
      border-right-color: rgba(102, 126, 234, 0.4);
      animation: orbit 4s linear infinite;
      z-index: 1;
    }
    /* 录音状态：快速旋转红色光环 */
    .sprite-container.recording .orbit-ring {
      border-top-color: rgba(229, 57, 53, 0.8);
      border-right-color: rgba(229, 57, 53, 0.4);
      animation: orbit 1.2s linear infinite;
    }
    @keyframes orbit {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="sprite-container" id="container">
    <div class="orbit-ring"></div>
    <div class="sprite-ball" id="sprite">
      <img id="sprite-icon" class="sprite-icon" src="" alt="icon">
      <div class="recording-icon"></div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const container = document.getElementById('container');
    const sprite = document.getElementById('sprite');
    
    // 双击检测时间阈值（毫秒）
    const DOUBLE_CLICK_THRESHOLD = 300;

    // 接收图标
    ipcRenderer.on('set-sprite-icon', (event, dataUrl) => {
      document.getElementById('sprite-icon').src = dataUrl;
    });

    // 监听录音状态变化
    ipcRenderer.on('meeting-recording-state', (event, isRecording) => {
      if (isRecording) {
        sprite.classList.add('recording');
        container.classList.add('recording');
      } else {
        sprite.classList.remove('recording');
        container.classList.remove('recording');
      }
    });

    // ========== 拖拽逻辑 ==========
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    container.addEventListener('mousedown', (e) => {
      if (e.button === 0) {
        ipcRenderer.invoke('sprite-get-position').then(winPos => {
          isDragging = true;
          dragOffsetX = e.screenX - winPos.x;
          dragOffsetY = e.screenY - winPos.y;
          sprite.classList.add('dragging');
        });
      }
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const newX = e.screenX - dragOffsetX;
        const newY = e.screenY - dragOffsetY;
        ipcRenderer.send('sprite-set-position', newX, newY);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (e.button === 0) {
        isDragging = false;
        sprite.classList.remove('dragging');
      }
    });

    // 双击检测 - 打开会议助手窗口（需要检查可用性）
    let lastClickTime = 0;
    container.addEventListener('click', async (e) => {
      if (e.button === 0 && !isDragging) {
        const now = Date.now();
        if (now - lastClickTime < DOUBLE_CLICK_THRESHOLD) {
          // 双击：检查会议助手是否可用
          const available = await ipcRenderer.invoke('meeting-assistant-available');
          if (available) {
            ipcRenderer.send('open-meeting-assistant');
          } else {
            // 不可用时恢复主窗口
            ipcRenderer.send('sprite-restore');
          }
          lastClickTime = 0;
        } else {
          lastClickTime = now;
        }
      }
    });

    // 右键菜单
    container.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      ipcRenderer.send('sprite-context-menu');
    });
  </script>
</body>
</html>
